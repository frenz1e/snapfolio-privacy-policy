<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Technical Documentation — SnapFolio.AI</title>
  <meta name="description" content="SnapFolio.AI technical documentation: tech stack, architecture, and RevenueCat subscription implementation.">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.7;
      color: #1a1a2e;
      background: #fafafa;
      padding: 0 20px;
    }
    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 48px 0 80px;
    }
    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .subtitle {
      color: #888;
      font-size: 14px;
      margin-bottom: 36px;
    }
    h2 {
      font-size: 20px;
      font-weight: 600;
      margin-top: 32px;
      margin-bottom: 12px;
    }
    h3 {
      font-size: 16px;
      font-weight: 600;
      margin-top: 18px;
      margin-bottom: 8px;
      color: #222;
    }
    p, li {
      font-size: 15px;
      color: #333;
      margin-bottom: 12px;
    }
    ul, ol {
      padding-left: 24px;
      margin-bottom: 12px;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      font-size: 0.95em;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 6px;
    }
    .codeblock {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      font-size: 13px;
      background: #f0f0f0;
      padding: 12px 14px;
      border-radius: 10px;
      overflow-x: auto;
      margin: 12px 0 16px;
      color: #222;
      white-space: pre;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0 16px;
      font-size: 15px;
    }
    th, td {
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid #e0e0e0;
      color: #333;
    }
    th {
      font-weight: 600;
      color: #222;
      background: #f5f5f5;
    }
    a {
      color: #007AFF;
      text-decoration: none;
    }
    a:hover { text-decoration: underline; }
    hr {
      border: none;
      border-top: 1px solid #e0e0e0;
      margin: 32px 0;
    }
    .footer {
      margin-top: 48px;
      padding-top: 24px;
      border-top: 1px solid #e0e0e0;
      font-size: 13px;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SnapFolio.AI — Technical Documentation</h1>

    <h2>1. Overview</h2>
    <p><strong>SnapFolio.AI</strong> is a privacy-first, AI-powered portfolio tracker for iOS and Android. Users photograph brokerage statements, the app extracts holdings via AI (Google Gemini), and tracks values in real-time using TwelveData market data. Premium features are monetized through RevenueCat in-app subscriptions.</p>
    <p><strong>Core philosophy:</strong> Local-first — all data lives on-device in SQLite. No user accounts, no backend database. Data only leaves the device for AI extraction and price lookups.</p>

    <h3>Tech Stack</h3>
    <table>
      <thead>
        <tr><th>Layer</th><th>Technology</th></tr>
      </thead>
      <tbody>
        <tr><td>Framework</td><td>React Native (Expo SDK 54), TypeScript</td></tr>
        <tr><td>Navigation</td><td>Expo Router v6 (file-based)</td></tr>
        <tr><td>State</td><td>Zustand</td></tr>
        <tr><td>Database</td><td>SQLite (expo-sqlite)</td></tr>
        <tr><td>AI</td><td>Google Gemini API (gemini-2.5-flash)</td></tr>
        <tr><td>Market Data</td><td>TwelveData via Fly.io proxy</td></tr>
        <tr><td>Subscriptions</td><td>RevenueCat (react-native-purchases)</td></tr>
      </tbody>
    </table>

    <hr>

    <h2>2. Architecture</h2>

    <h3>High-Level Diagram</h3>
    <div class="codeblock">┌─────────────────────────────────────────────────────────┐
│                      UI Layer                           │
│  Expo Router screens → components → craftrn-ui library  │
└──────────────┬──────────────────────────┬───────────────┘
               │                          │
       ┌───────▼───────┐          ┌───────▼───────┐
       │  Zustand       │          │  React Hooks   │
       │  Stores        │          │  (side effects)│
       └───────┬───────┘          └───────┬───────┘
               │                          │
       ┌───────▼──────────────────────────▼───────┐
       │             Service Layer                 │
       │  ai/ · market-data/ · purchases/ · risk/  │
       └───────┬──────────────────────────┬───────┘
               │                          │
       ┌───────▼───────┐          ┌───────▼───────┐
       │  Repositories  │          │  External APIs │
       │  (SQLite DAOs) │          │  Gemini, 12Data│
       └───────┬───────┘          │  RevenueCat    │
               │                  └────────────────┘
       ┌───────▼───────┐
       │  SQLite DB     │
       │  (on-device)   │
       └───────────────┘</div>

    <h3>Project Structure</h3>
    <div class="codeblock">snapfolio/
├── app/                    # Screens (file-based routing)
│   ├── _layout.tsx         # Root: DB init, theme, providers
│   ├── paywall.tsx         # Subscription paywall (modal)
│   ├── (tabs)/             # Bottom tabs: portfolio, assets, insights, settings
│   └── import/             # Modal stack: capture → account → preview → confirm
├── stores/                 # Zustand stores (portfolio, metadata, purchases, import)
├── services/               # Business logic &amp; API clients
├── db/                     # Migrations + repositories (SQLite DAOs)
├── entities/               # Domain types (Asset, AssetType, ValuationMethod)
├── hooks/                  # React hooks (price refresh, feature gating)
├── config/                 # Feature tier limits (free vs premium)
├── craftrn-ui/             # Custom UI component library
└── components/             # Feature-specific UI components</div>

    <h3>Key Data Flows</h3>
    <p><strong>App launch:</strong> SQLite init → load stores from DB → RevenueCat packages (non-blocking) → price refresh hook starts 30s polling.</p>
    <p><strong>AI Import:</strong> Photo → Gemini extraction → live price enrichment → smart merge (new/update/unchanged/missing) → transactional DB write.</p>
    <p><strong>Price refresh:</strong> Filter market assets → fetch via proxy → diff check (skip if unchanged) → write to DB → recompute charts → atomic store update.</p>

    <hr>

    <h2>3. TwelveData — Market Data Provider</h2>

    <h3>Architecture</h3>
    <p>The app communicates through a <strong>backend proxy</strong> on Fly.io — it never calls TwelveData directly:</p>
    <div class="codeblock">Mobile App  ──(x-api-key)──►  market-data-backend.fly.dev  ──(TwelveData key)──►  TwelveData API</div>
    <p>This keeps the TwelveData API key server-side and allows caching, rate limiting, and symbol normalization.</p>

    <h3>Proxy Endpoints</h3>
    <table>
      <thead>
        <tr><th>Endpoint</th><th>Purpose</th></tr>
      </thead>
      <tbody>
        <tr><td><code>GET /prices-new?symbols=AAPL,BTC/USD</code></td><td>Current prices (batch)</td></tr>
        <tr><td><code>GET /timeseries?symbols=...&amp;start_date=...&amp;interval=1day</code></td><td>Historical daily prices</td></tr>
        <tr><td><code>GET /statistics?symbol=AAPL</code></td><td>Fundamentals (PE, beta, etc.) — 24h cache</td></tr>
        <tr><td><code>GET /profile?symbol=AAPL</code></td><td>Sector, region, description</td></tr>
      </tbody>
    </table>

    <h3>How Prices Flow</h3>
    <ol>
      <li><strong><code>usePriceRefresh</code> hook</strong> — triggers on: asset changes, 30s interval, app foreground</li>
      <li><strong>Price Orchestrator</strong> (<code>services/market-data/price-orchestrator.ts</code>) — stateless coordinator:
        <ul>
          <li>Fetches current prices, diffs against in-memory state</li>
          <li>Writes changes to DB + <code>price_history</code> table</li>
          <li>On first run / new assets: fetches 90-day historical timeseries</li>
        </ul>
      </li>
      <li><strong>Price Enricher</strong> — during import, fetches live prices for AI-extracted assets (10s timeout, non-blocking)</li>
      <li><strong>Symbol mapping:</strong> crypto symbols get <code>/USD</code> suffix (e.g., <code>BTC</code> → <code>BTC/USD</code>); all symbols uppercased and deduped</li>
    </ol>

    <hr>

    <h2>4. RevenueCat — Subscription Integration</h2>

    <h3>Overview</h3>
    <p>RevenueCat manages iOS in-app subscriptions with a single <code>"premium"</code> entitlement. The integration spans three layers:</p>
    <div class="codeblock">config/features.ts          ← Feature tier definitions (free vs premium limits)
        │
services/purchases/         ← RevenueCat SDK wrapper (stateless API calls)
        │
stores/purchases-store.ts   ← Reactive state (isPremium, packages, customerInfo)
        │
app/paywall.tsx             ← Purchase UI (full-screen modal)</div>

    <h3>SDK Configuration</h3>
    <ul>
      <li><strong>SDK:</strong> <code>react-native-purchases</code> v9.7.6</li>
      <li><strong>API Key:</strong> <code>EXPO_PUBLIC_REVENUECAT_IOS_API_KEY</code></li>
      <li><strong>Entitlement:</strong> <code>"premium"</code></li>
      <li><strong>Init strategy:</strong> Configured eagerly on module import; gracefully degrades if API key is missing</li>
    </ul>
    <div class="codeblock">// services/purchases/purchases-service.ts
const isConfigured = configureRevenueCat(); // runs on import</div>

    <h3>Service Layer</h3>
    <p><code>PurchasesService</code> is a singleton wrapping the RevenueCat SDK:</p>
    <table>
      <thead>
        <tr><th>Method</th><th>What it does</th></tr>
      </thead>
      <tbody>
        <tr><td><code>loadPackages()</code></td><td>Fetches offerings + customer info in parallel</td></tr>
        <tr><td><code>purchasePackage(pkg)</code></td><td>Initiates purchase; returns <code>{ cancelled: true }</code> on cancel (not an error)</td></tr>
        <tr><td><code>restorePurchases()</code></td><td>Restores for returning subscribers</td></tr>
        <tr><td><code>getCustomerInfo()</code></td><td>Checks current entitlement status</td></tr>
      </tbody>
    </table>
    <p>All methods return typed result objects — no thrown exceptions reach the UI.</p>

    <h3>State Management</h3>
    <p><code>usePurchasesStore</code> (Zustand) bridges the service with the UI:</p>
    <div class="codeblock">{
  isPremium: boolean,           // derived from active "premium" entitlement
  packages: PurchasesPackage[], // available plans from RevenueCat
  customerInfo: CustomerInfo,   // full RevenueCat customer object
  isLoading: boolean,
  isInitialized: boolean,       // prevents duplicate init calls
}</div>
    <ul>
      <li><strong>On launch:</strong> <code>loadPurchases()</code> fetches packages + entitlements (non-blocking)</li>
      <li><strong>On foreground:</strong> <code>refreshPremiumStatus()</code> re-checks entitlements (catches App Store changes)</li>
    </ul>

    <h3>Feature Gating</h3>
    <p>Feature limits are defined in <code>config/features.ts</code> — decoupled from the SDK:</p>
    <table>
      <thead>
        <tr><th>Feature</th><th>Free</th><th>Premium</th></tr>
      </thead>
      <tbody>
        <tr><td>AI Import</td><td>no</td><td>yes</td></tr>
        <tr><td>Insights</td><td>no</td><td>yes</td></tr>
        <tr><td>Reminders</td><td>no</td><td>yes</td></tr>
        <tr><td>Live Prices</td><td>yes</td><td>yes</td></tr>
        <tr><td>Asset Limit</td><td>5</td><td>999</td></tr>
      </tbody>
    </table>
    <p>Accessed via <code>useFeatures()</code> hook:</p>
    <div class="codeblock">const { insights, isPremium, canAddAsset } = useFeatures();
if (!insights) router.push('/paywall');</div>

    <h3>Subscription Lifecycle</h3>
    <div class="codeblock">App Launch
  └─ loadPurchases() → fetch offerings + entitlements → set isPremium

User hits premium feature
  └─ useFeatures() → not premium → redirect to /paywall
       ├─ Purchase → StoreKit → RevenueCat validates → isPremium = true
       └─ Cancel → stay on paywall

App returns to foreground
  └─ refreshPremiumStatus() → re-check entitlements</div>

    <h3>Paywall</h3>
    <p><code>app/paywall.tsx</code> — full-screen modal presenting:</p>
    <ul>
      <li>Available subscription packages (from RevenueCat offerings)</li>
      <li>1-week free trial info</li>
      <li>Restore Purchases option</li>
      <li>Privacy Policy / Terms of Service links</li>
    </ul>

    <div class="footer">
      <p>&copy; 2026 SnapFolio.AI. All rights reserved. | <a href="privacy.html">Privacy Policy</a> | <a href="terms.html">Terms</a> | <a href="proposal.html">Proposal</a></p>
    </div>
  </div>
</body>
</html>
